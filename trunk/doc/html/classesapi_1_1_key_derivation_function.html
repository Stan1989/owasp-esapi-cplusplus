<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>OWASP ESAPI for C Plus Plus: esapi::KeyDerivationFunction Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OWASP ESAPI for C Plus Plus
   &#160;<span id="projectnumber">ALPHA</span>
   </div>
   <div id="projectbrief">An API for helping programmers develop more secure business applications in C++</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="classes.html"><span>Class&#160;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="namespaceesapi.html">esapi</a>      </li>
      <li class="navelem"><a class="el" href="classesapi_1_1_key_derivation_function.html">KeyDerivationFunction</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-static-methods">Static Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">esapi::KeyDerivationFunction Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="esapi::KeyDerivationFunction" -->
<p><code>#include &lt;<a class="el" href="_key_derivation_function_8h_source.html">KeyDerivationFunction.h</a>&gt;</code></p>

<p><a href="classesapi_1_1_key_derivation_function-members.html">List of all members.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="classesapi_1_1_secret_key.html">SecretKey</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classesapi_1_1_key_derivation_function.html#acacd3023f62fbec66d0f987e0eca5a24">computeDerivedKey</a> (const <a class="el" href="classesapi_1_1_secret_key.html">SecretKey</a> &amp;keyDerivationKey, unsigned int keyBits, const <a class="el" href="namespaceesapi.html#ac7e5578df54f144516577c5bb1c833f1">String</a> &amp;purpose)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static unsigned int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classesapi_1_1_key_derivation_function.html#a3b39acca899abb0e6dd4528d3d16fa79">calcKeySize</a> (unsigned int keyBits)</td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock">
<p>Definition at line <a class="el" href="_key_derivation_function_8h_source.html#l00042">42</a> of file <a class="el" href="_key_derivation_function_8h_source.html">KeyDerivationFunction.h</a>.</p>
</div><hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a3b39acca899abb0e6dd4528d3d16fa79"></a><!-- doxytag: member="esapi::KeyDerivationFunction::calcKeySize" ref="a3b39acca899abb0e6dd4528d3d16fa79" args="(unsigned int keyBits)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int <a class="el" href="classesapi_1_1_key_derivation_function.html#a3b39acca899abb0e6dd4528d3d16fa79">esapi::KeyDerivationFunction::calcKeySize</a> </td>
          <td>(</td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>keyBits</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Check if specified algorithm name is a valid PRF that can be used. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">prfAlgNameName</td><td>of the PRF algorithm; e.g., "HmacSHA1", "HmacSHA384", etc.  if <div class="fragment"><pre class="fragment"> prfAlgName 
</pre></div> is supported, otherwise false. Calculate the size of a key. The key size is given in bits, but we can only allocate them by octets (i.e., bytes), so make sure we round up to the next whole number of octets. For example, a key size of 9 bits would require 2 octets to store it. </td></tr>
    <tr><td class="paramname">keyBits</td><td>The key size, in bits. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>The key size, in octets, large enough to accommodate <div class="fragment"><pre class="fragment"> keyBits 
</pre></div> bits. </dd></dl>
<dl class="exception"><dt><b>Exceptions:</b></dt><dd>
  <table class="exception">
    <tr><td class="paramname">&lt;i&gt;YEP!&lt;/i&gt;,if</td><td>you wrap the value.</td></tr>
  </table>
  </dd>
</dl>
<p>Check if specified algorithm name is a valid PRF that can be used. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">prfAlgName</td><td>Name of the PRF algorithm; e.g., "HmacSHA1", "HmacSHA384", etc. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>True if <div class="fragment"><pre class="fragment"> prfAlgName 
</pre></div> is supported, otherwise false. public static boolean isValidPRF(String prfAlgName) { for (PRF_ALGORITHMS prf : PRF_ALGORITHMS.values()) { if ( prf.getAlgName().equals(prfAlgName) ) { return true; } } return false; }</dd></dl>
<p>public static PRF_ALGORITHMS convertNameToPRF(String prfAlgName) { for (PRF_ALGORITHMS prf : PRF_ALGORITHMS.values()) { if ( prf.getAlgName().equals(prfAlgName) ) { return prf; } } throw <a class="el" href="classesapi_1_1_illegal_argument_exception.html">IllegalArgumentException</a>("Algorithm name " + prfAlgName + " not a valid PRF algorithm name for the ESAPI KDF"); }</p>
<p>public static PRF_ALGORITHMS convertIntToPRF(int selection) { for (PRF_ALGORITHMS prf : PRF_ALGORITHMS.values()) { if ( prf.getValue() == selection ) { return prf; } } throw <a class="el" href="classesapi_1_1_illegal_argument_exception.html">IllegalArgumentException</a>("No KDF PRF algorithm found for value name " + selection); } Calculate the size of a key. </p>

<p>Definition at line <a class="el" href="_key_derivation_function_8cpp_source.html#l00270">270</a> of file <a class="el" href="_key_derivation_function_8cpp_source.html">KeyDerivationFunction.cpp</a>.</p>

</div>
</div>
<a class="anchor" id="acacd3023f62fbec66d0f987e0eca5a24"></a><!-- doxytag: member="esapi::KeyDerivationFunction::computeDerivedKey" ref="acacd3023f62fbec66d0f987e0eca5a24" args="(const SecretKey &amp;keyDerivationKey, unsigned int keyBits, const String &amp;purpose)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classesapi_1_1_secret_key.html">SecretKey</a> <a class="el" href="classesapi_1_1_key_derivation_function.html#acacd3023f62fbec66d0f987e0eca5a24">esapi::KeyDerivationFunction::computeDerivedKey</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classesapi_1_1_secret_key.html">SecretKey</a> &amp;&#160;</td>
          <td class="paramname"><em>keyDerivationKey</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned int&#160;</td>
          <td class="paramname"><em>keyBits</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="namespaceesapi.html#ac7e5578df54f144516577c5bb1c833f1">String</a> &amp;&#160;</td>
          <td class="paramname"><em>purpose</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>The method is ESAPI's <a class="el" href="classesapi_1_1_key.html">Key</a> Derivation Function (KDF) that computes a derived key from the </p>
<div class="fragment"><pre class="fragment"> keyDerivationKey 
</pre></div><p> for either encryption / decryption or for authentication.</p>
<p>CAUTION: If this algorithm for computing derived keys from the key derivation key is ever changed, we risk breaking backward compatibility of being able to decrypt data previously encrypted with earlier / different versions of this method. Therefore, do not change this unless you are 100% certain that what you are doing will NOT change either of the derived keys for ANY "key derivation key" AT ALL!!!</p>
<p>NOTE: This method is generally not intended to be called separately. It is used by ESAPI's reference crypto implementation class </p>
<div class="fragment"><pre class="fragment"> JavaEncryptor 
</pre></div><p> and might be useful for someone implementing their own replacement class, but generally it is not something that is useful to application client code.</p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">keyDerivationKey</td><td>A key used as an input to a key derivation function to derive other keys. This is the key that generally is created using some key generation mechanism such as <a class="el" href="">generateSecretKey(String, int)</a>. The "input" key from which the other keys are derived. The derived key will have the same algorithm type * as this key. This KDK cannot be null. </td></tr>
    <tr><td class="paramname">keySizeThe</td><td>cipher's key size (in bits) for the <div class="fragment"><pre class="fragment"> keyDerivationKey 
</pre></div> . Must have a minimum size of 56 bits and be an integral multiple of 8-bits. Note: The derived key will have the same size as this. </td></tr>
    <tr><td class="paramname">purpose</td><td>The purpose for the derived key. For the ESAPI reference implementation, <div class="fragment"><pre class="fragment"> JavaEncryptor 
</pre></div> , this must be either the string "encryption" or "authenticity", where "encryption" is used for creating a derived key to use for confidentiality, and "authenticity" is used for creating a derived key to use with a MAC to ensure message authenticity. However, since parameter serves the same purpose as the "Label" in section 5.1 of NIST SP 800-108, it really can be set to anything other than <div class="fragment"><pre class="fragment"> null 
</pre></div> or an empty string when called outside of <div class="fragment"><pre class="fragment"> JavaEncryptor 
</pre></div> .  derived <div class="fragment"><pre class="fragment"> SecretKey 
</pre></div> to be used according to the specified purpose. </td></tr>
  </table>
  </dd>
</dl>
<dl class="exception"><dt><b>Exceptions:</b></dt><dd>
  <table class="exception">
    <tr><td class="paramname">NoSuchAlgorithmExceptionThe</td><td><div class="fragment"><pre class="fragment"> keyDerivationKey 
</pre></div> has an unsupported encryption algorithm or no current JCE provider supports "HmacSHA1". </td></tr>
    <tr><td class="paramname">EncryptionExceptionIf</td><td>"UTF-8" is not supported as an encoding, then this is thrown with the original <div class="fragment"><pre class="fragment"> UnsupportedEncodingException 
</pre></div> as the cause. (NOTE: This should never happen as "UTF-8" is supposed to be a common encoding supported by all Java implementations. Support for it is usually in rt.jar.) </td></tr>
  </table>
  </dd>
</dl>
<p>byte[] derivedKey = new byte[ keySize ]; byte[] label; // Same purpose as NIST SP 800-108's "label" in section 5.1. byte[] context; // See setContext() for details. try { label = purpose.getBytes(L"UTF-8"); context = context_.getBytes(L"UTF-8"); } catch (UnsupportedEncodingException e) { throw <a class="el" href="classesapi_1_1_encryption_exception.html">EncryptionException</a>("Encryption failure (internal encoding error: UTF-8)", "UTF-8 encoding is NOT supported as a standard byte encoding: " + e.getMessage(), e); }</p>
<p><a class="el" href="classesapi_1_1_secret_key.html">SecretKey</a> sk = new SecretKeySpec(keyDerivationKey.getEncoded(), "HmacSHA1"); Mac mac = null;</p>
<p>try { mac = Mac.getInstance(L"HmacSHA1"); mac.init(sk); } catch( InvalidKeyException ex ) { logger.error(<a class="el" href="classesapi_1_1_logger.html#a8767d14c150667386b6dde44f9c4cf30">Logger.SECURITY_FAILURE</a>, "Created HmacSHA1 Mac but SecretKey sk has alg " + sk.getAlgorithm(), ex); throw ex; }</p>
<p>Repeatedly call of HmacSHA1 hash until we've collected enough bits for the derived key. The first time through, we calculate the HmacSHA1 on the "purpose" string, but subsequent calculations are performed on the previous result. int ctr = 1; // Iteration counter for NIST 800-108 int totalCopied = 0; int destPos = 0; int len = 0; byte[] tmpKey = null; // Do not declare inside do-while loop!!! do {</p>
<p>This is to make our KDF more along the line of NIST's. NIST's Special Publication 800-108 performs the following in the iterative loop of Section 5.1: n := number of blocks required to fulfill request for i = 1 to n, do K(i) := PRF(KDK, [i]2 || Label || 0x00 || Context || [L]2) result(i) := result(i-1) || K(i) end where '||' is represents bit string concatenation, and PRF is an NIST approved pseudo-random function (such as an HMAC), KDK is the key derivation key, [i]2 is the big-endian binary representation of the iteration, and [L]2 is the bits requested by the caller, and 0x00 represents a null byte used as a separation indicator. However, other sections of this document (Section 7.6) implies that Context is to be an optional field (based on NIST's use of the word SHOULD rather than MUST)</p>
<p>mac.update( ByteConversionUtil.fromInt( ctr++ ) ); mac.update(label); mac.update((byte) '\0'); mac.update(context); // This is problematic for us. See Jeff Walton's analysis of ESAPI 2.0's KDF for details. Maybe for 2.1, we'll see; 2.0 too close to GA.</p>
<p>According to the Javadoc for Mac.doFinal(byte[]), "A call to this method resets this Mac object to the state it was in when previously initialized via a call to init(Key) or init(Key, AlgorithmParameterSpec). That is, the object is reset and available to generate another MAC from the same key, if desired, via new calls to update and doFinal." Therefore, we do not do an explicit reset(). tmpKey = mac.doFinal( ByteConversionUtil.fromInt( keySize ) );</p>
<p>if ( tmpKey.length &gt;= keySize ) { len = keySize; } else { len = Math.min(tmpKey.length, keySize - totalCopied); }</p>
<p>System.arraycopy(tmpKey, 0, derivedKey, destPos, len); label = tmpKey; totalCopied += tmpKey.length; destPos += len; } while( totalCopied &lt; keySize );</p>
<p>Don't leave remnants of the partial key in memory. (Note: we could not do this if tmpKey were declared in the do-while loop. for ( int i = 0; i &lt; tmpKey.length; i++ ) { tmpKey[i] = L'\0'; } tmpKey = null; // Make it immediately eligible for GC.</p>

<p>Definition at line <a class="el" href="_key_derivation_function_8cpp_source.html#l00050">50</a> of file <a class="el" href="_key_derivation_function_8cpp_source.html">KeyDerivationFunction.cpp</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>esapi/crypto/<a class="el" href="_key_derivation_function_8h_source.html">KeyDerivationFunction.h</a></li>
<li>src/crypto/<a class="el" href="_key_derivation_function_8cpp_source.html">KeyDerivationFunction.cpp</a></li>
</ul>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Sat Jan 21 2012 12:32:26 for OWASP ESAPI for C Plus Plus by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
